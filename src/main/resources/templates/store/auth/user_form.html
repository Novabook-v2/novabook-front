<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NovaBook📕</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!--  ajax mix content  -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Google Font -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700|Raleway:400,300,500,700,600'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css"
          type="text/css">
    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        .button-container {
            text-align: center;
            margin-top: 20px; /* 버튼들 사이 간격 조정 */
        }

        .button-container .but3, .button-container .but4 {
            margin: 0 10px; /* 버튼들 사이 간격 조정 */
        }

        #register-button[disabled] {
            background-color: #ccc;
            border-color: #ccc;
            color: #555;
        }
    </style>
</head>
<body>
<div th:replace="~{layout/store/nav::nav}"></div>

<div class="register-container">

    <form method="post" action="/users/user/form" onsubmit="return formCheck(this);">
        <div class="container">
            <div class="insert">
                <table>
                    <caption><h2 th:text="#{user_form.title}">회원가입 양식</h2></caption>
                    <tr>
                        <td class="col1" th:text="#{user_form.name}">이름</td>
                        <td class="col2"><input type="text" name="name" maxlength="20"></td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.id}">아이디</td>
                        <td class="col2">
                            <input type="text" id="loginId" name="loginId" maxlength="20"
                                   oninput="handleInputIdChange()">
                            <input class="but1" type="button" th:value="#{user_form.check.duplicate.id}" onclick="checkDuplicateId()">
                            <span id="idMessage" class="error-message"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.password}">비밀번호</td>
                        <td class="col2">
                            <input type="password" id="loginPassword" name="loginPassword" maxlength="16">
                            <p th:text="#{user_form.password.hint}">※비밀번호는 문자, 숫자, 특수문자(~!@#$%^&*)의 조합 10 ~ 16자리로 입력이 가능합니다.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.password.confirm}">비밀번호 확인</td>
                        <td class="col2">
                            <input type="password" id="loginPasswordConfirm" name="loginPasswordConfirm" maxlength="16">
                            <span id="passwordMessage"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.email}">이메일</td>
                        <td class="col2">
                            <input type="text" id="email" name="email" oninput="handleInputEmailChange()">
                            <span class="a">@</span>
                            <input type="text" id="emailDomain" name="emailDomain">
                            <select name="mailslc" onchange="updateEmail()">
                                <option value="self" selected th:text="#{user_form.select}">직접입력</option>
                                <option value="naver">naver.com</option>
                                <option value="gm">gmail.com</option>
                                <option value="da">daum.com</option>
                                <option value="yah">yahoo.com</option>
                            </select>
                            <input class="but2" type="button" th:value="#{user_form.check.duplicate.email}" onclick="checkDuplicateEmail()">
                            <span id="emailMessage" class="error-message"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.birthdate}">생년월일</td>
                        <td class="col2">
                            <select id="birth_year" name="birthYear" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">선택</option>
                                <script>
                                    for (let i = 2023; i >= 1900; i--) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                            <select id="birth_month" name="birthMonth" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">선택</option>
                                <script>
                                    for (let i = 1; i <= 12; i++) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                            <select id="birth_day" name="birthDay" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">선택</option>
                                <script>
                                    for (let i = 1; i <= 31; i++) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.address}">주소</td>
                        <td class="col2">
                            <input type="text" id="postcode" name="postcode" readonly placeholder="우편번호">
                            <input class="but1" type="button" onclick="execPostcode()" th:value="#{user_form.find.postcode}">
                            <input type="text" id="address" name="address" readonly placeholder="주소">
                            <input type="text" id="detailAddress" name="detailAddress" placeholder="상세주소">
                            <input type="text" id="extraAddress" name="extraAddress" placeholder="참고항목">
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.contact}">연락처</td>
                        <td class="col2"><input type="text" name="contact"></td>
                    </tr>
                </table>
                <div class="button-container">
                    <input class="but3" id="register-button" type="submit" th:value="#{user_form.submit}" disabled>
                    <button class="but4" th:text="#{user_form.cancel}" onclick="location.href='/'"></button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    // 자바스크립트 함수들
    // 중복 확인을 위한 함수들
    function checkDuplicateId() {
        const loginId = $('#loginId').val();
        if (loginId.trim() === '') {
            alert("아이디를 입력해주세요.");
            return;
        }

        axios.get(`/api/users/check-duplicate-id?loginId=${loginId}`)
            .then(response => {
                if (response.data.duplicate) {
                    $('#idMessage').text("사용할 수 없는 아이디입니다.").css('color', 'red');
                } else {
                    $('#idMessage').text("사용할 수 있는 아이디입니다.").css('color', 'green');
                }
            })
            .catch(error => {
                console.error(error);
                alert("중복 확인 중 오류가 발생했습니다.");
            });
    }

    function checkDuplicateEmail() {
        const email = $('#email').val() + '@' + $('#emailDomain').val();
        if (email.trim() === '@') {
            alert("이메일을 입력해주세요.");
            return;
        }

        axios.get(`/api/users/check-duplicate-email?email=${email}`)
            .then(response => {
                if (response.data.duplicate) {
                    $('#emailMessage').text("이미 사용 중인 이메일입니다.").css('color', 'red');
                } else {
                    $('#emailMessage').text("사용할 수 있는 이메일입니다.").css('color', 'green');
                }
            })
            .catch(error => {
                console.error(error);
                alert("중복 확인 중 오류가 발생했습니다.");
            });
    }

    // 이메일 도메인 업데이트 함수
    function updateEmail() {
        const emailSelect = $('select[name="mailslc"]').val();
        const emailDomain = $('#emailDomain');

        if (emailSelect === 'self') {
            emailDomain.val('').prop('readonly', false);
        } else {
            emailDomain.val(emailSelect).prop('readonly', true);
        }
    }

    // 비밀번호 일치 확인 함수
    function validatePassword() {
        const password = $('#loginPassword').val();
        const confirmPassword = $('#loginPasswordConfirm').val();

        if (password !== confirmPassword) {
            $('#passwordMessage').text("비밀번호가 일치하지 않습니다.").css('color', 'red');
            return false;
        } else {
            $('#passwordMessage').text("");
            return true;
        }
    }

    // 비밀번호 유효성 검사
    function checkPasswordValidity() {
        const password = $('#loginPassword').val();
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[~!@#$%^&*]).{10,16}$/;

        if (!passwordRegex.test(password)) {
            alert("비밀번호는 문자, 숫자, 특수문자(~!@#$%^&*)의 조합 10 ~ 16자리여야 합니다.");
            return false;
        }
        return true;
    }

    // 폼 제출 전 확인
    function formCheck(form) {
        const name = $('input[name="name"]').val().trim();
        const loginId = $('input[name="loginId"]').val().trim();
        const email = $('#email').val().trim() + '@' + $('#emailDomain').val().trim();
        const birthYear = $('#birth_year').val();
        const birthMonth = $('#birth_month').val();
        const birthDay = $('#birth_day').val();
        const address = $('#address').val().trim();
        const contact = $('input[name="contact"]').val().trim();

        if (name === '') {
            alert("이름을 입력해주세요.");
            return false;
        }
        if (loginId === '') {
            alert("아이디를 입력해주세요.");
            return false;
        }
        if (!checkPasswordValidity()) {
            return false;
        }
        if (!validatePassword()) {
            return false;
        }
        if (email === '@') {
            alert("올바른 이메일 주소를 입력해주세요.");
            return false;
        }
        if (birthYear === 'none' || birthMonth === 'none' || birthDay === 'none') {
            alert("생년월일을 모두 선택해주세요.");
            return false;
        }
        if (address === '') {
            alert("주소를 입력해주세요.");
            return false;
        }
        if (contact === '') {
            alert("연락처를 입력해주세요.");
            return false;
        }
        return true;
    }

    // 주소 찾기 API
    function execPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var fullAddr = ''; // 최종 주소 변수
                var extraAddr = ''; // 조합형 주소 변수

                if (data.userSelectedType === 'R') {
                    fullAddr = data.roadAddress;
                } else {
                    fullAddr = data.jibunAddress;
                }

                if (data.userSelectedType === 'R') {
                    if (data.bname !== '') {
                        extraAddr += data.bname;
                    }
                    if (data.buildingName !== '') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
                }

                $('#postcode').val(data.zonecode);
                $('#address').val(fullAddr);
                $('#detailAddress').focus();
            }
        }).open();
    }

    function handleInputIdChange() {
        const idMessage = document.getElementById("idMessage");
        idMessage.textContent = "";
    }

    function handleInputEmailChange() {
        const emailMessage = document.getElementById("emailMessage");
        emailMessage.textContent = "";
    }
</script>
</body>
</html>
